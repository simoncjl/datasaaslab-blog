---
import { getCollection } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { LOCALES, type Locale } from '../../../lib/i18n';
import { buildAbsoluteUrl } from '../../../lib/seo';
import { estimateReadingTime } from '../../../lib/readingTime';

const langParam = Astro.params.lang;
if (!langParam || !LOCALES.includes(langParam as Locale)) {
  return Astro.redirect('/fr/blog', 302);
}

const lang = langParam as Locale;
const includeDrafts = import.meta.env.DEV;

const posts = (await getCollection(
  'blog',
  ({ data }) => data.lang === lang && data.kind === 'post' && (includeDrafts || !data.draft),
)).sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const availableTags = [...new Set(posts.flatMap((post) => post.data.tags ?? []))].sort((a, b) =>
  a.localeCompare(b),
);

const pageTitle = 'Blog | DataSaaSLab';
const pageDescription = lang === 'fr' ? 'Articles DataSaaSLab en francais.' : 'DataSaaSLab articles in English.';

const canonicalPath = `/${lang}/blog`;
const canonicalUrl = buildAbsoluteUrl(canonicalPath);
const frAltUrl = buildAbsoluteUrl('/fr/blog');
const enAltUrl = buildAbsoluteUrl('/en/blog');

const formatDate = (value: Date) =>
  new Intl.DateTimeFormat(lang === 'fr' ? 'fr-FR' : 'en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
  }).format(value);
---

<BaseLayout title={pageTitle} description={pageDescription}>
  <Fragment slot="head">
    {canonicalUrl && <link rel="canonical" href={canonicalUrl} />}
    {frAltUrl && <link rel="alternate" hreflang="fr" href={frAltUrl} />}
    {enAltUrl && <link rel="alternate" hreflang="en" href={enAltUrl} />}
    <meta name="description" content={pageDescription} />
    <meta property="og:type" content="website" />
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={pageDescription} />
    {canonicalUrl && <meta property="og:url" content={canonicalUrl} />}
  </Fragment>

  <section>
    <h1>Blog</h1>

    {posts.length === 0 ? (
      <p>{lang === 'fr' ? 'Aucun article pour le moment.' : 'No posts yet.'}</p>
    ) : (
      <>
        {availableTags.length > 0 && (
          <div class="tag-chip-row page-tag-row">
            {availableTags.map((tag) => (
              <a class="tag-chip" href={`/${lang}/blog?tag=${encodeURIComponent(tag)}`} data-filter-link data-tag={tag}>
                {tag}
              </a>
            ))}
            <a class="filter-clear-link" href={`/${lang}/blog`} data-filter-clear hidden>
              {lang === 'fr' ? 'Effacer' : 'Clear'}
            </a>
          </div>
        )}

        <p class="filter-meta" data-filter-meta></p>

        <ul class="blog-post-list" data-post-list>
          {posts.map((post) => {
            const slug = post.id.split('/').pop() ?? post.id;
            const tags = post.data.tags ?? [];
            const reading = estimateReadingTime(post.body).minutes;
            return (
              <li data-post-item data-tags={tags.map((tag) => tag.toLowerCase()).join(',')}>
                <a href={`/${lang}/blog/${slug}`}>{post.data.title}</a>
                <small>{` - ${formatDate(post.data.date)} • ${reading} min`}</small>
                {tags.length > 0 && (
                  <div class="post-tags">
                    {tags.map((tag) => (
                      <a class="post-tag" href={`/${lang}/blog?tag=${encodeURIComponent(tag)}`} data-filter-link data-tag={tag}>
                        {tag}
                      </a>
                    ))}
                  </div>
                )}
              </li>
            );
          })}
        </ul>
      </>
    )}
  </section>
</BaseLayout>

<script is:inline>
  (() => {
    const posts = Array.from(document.querySelectorAll('[data-post-item]'));
    if (posts.length === 0) return;

    const params = new URLSearchParams(window.location.search);
    const activeTag = (params.get('tag') || '').trim().toLowerCase();
    const tagLinks = Array.from(document.querySelectorAll('[data-filter-link]'));
    const clearLink = document.querySelector('[data-filter-clear]');
    const meta = document.querySelector('[data-filter-meta]');

    let visibleCount = 0;

    for (const post of posts) {
      const tagValues = (post.getAttribute('data-tags') || '')
        .split(',')
        .map((tag) => tag.trim().toLowerCase())
        .filter(Boolean);

      const visible = !activeTag || tagValues.includes(activeTag);
      post.hidden = !visible;
      if (visible) visibleCount += 1;
    }

    for (const link of tagLinks) {
      const tag = (link.getAttribute('data-tag') || '').trim().toLowerCase();
      if (activeTag && tag === activeTag) {
        link.classList.add('is-active');
      }
    }

    if (clearLink && activeTag) {
      clearLink.hidden = false;
    }

    if (meta) {
      meta.textContent = activeTag ? `${visibleCount} / ${posts.length} · tag: ${activeTag}` : `${visibleCount} / ${posts.length}`;
    }
  })();
</script>
