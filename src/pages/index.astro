---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import PostCard from '../components/PostCard.astro';
import { localeFromPathname } from '../lib/i18n';
import { estimateReadingTime } from '../lib/readingTime';

const includeDrafts = import.meta.env.DEV;
const lang = localeFromPathname(Astro.url.pathname);
const entries = await getCollection('blog', ({ data }) => includeDrafts || !data.draft);

const latestTips = entries
  .filter((entry) => entry.data.kind === 'tip' && entry.data.lang === lang)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
  .slice(0, 6);

const latestPosts = entries
  .filter((entry) => entry.data.kind === 'post' && entry.data.lang === lang)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
  .slice(0, 6);

const tipDateFormat = new Intl.DateTimeFormat(lang === 'fr' ? 'fr-FR' : 'en-US', {
  month: 'short',
  day: 'numeric',
});
---

<BaseLayout title="DataSaaSLab">
  <section class="home-top-grid">
    <section class="hero hero-compact">
      <div class="hero-content">
        <h1>DataSaaSLab</h1>
        <p class="hero-subtitle">
          AI-assisted writing with human quality gates. Practical tips and technical deep dives on data, SaaS, and
          applied AI.
        </p>
        <div class="cta-row">
          <a class="button" href={`/${lang}/tips`}>Explore Tips</a>
          <a class="button button-secondary" href={`/${lang}/blog`}>Read Blog Posts</a>
        </div>
      </div>
    </section>

    <section class="latest-tips-panel">
      <h2>Latest Tips</h2>
      {latestTips.length === 0 ? (
        <p>No tips yet.</p>
      ) : (
        <ul class="tips-compact-list">
          {latestTips.slice(0, 4).map((tip) => {
            const slug = tip.id.split('/').pop() ?? tip.id;
            const href = `/${tip.data.lang}/blog/${slug}`;
            return (
              <li>
                <a href={href}>{tip.data.title}</a>
                <small>{tipDateFormat.format(tip.data.date)}</small>
              </li>
            );
          })}
        </ul>
      )}
    </section>
  </section>

  <section class="latest-block">
    <h2>Latest Posts</h2>
    {latestPosts.length === 0 ? (
      <p>No posts yet.</p>
    ) : (
      <div class="posts-grid">
        {latestPosts.map((post) => {
          const slug = post.id.split('/').pop() ?? post.id;
          const href = `/${post.data.lang}/blog/${slug}`;
          return (
            <PostCard
              href={href}
              title={post.data.title}
              description={post.data.description}
              date={post.data.date}
              lang={post.data.lang}
              readingTimeMinutes={estimateReadingTime(post.body).minutes}
              aiAssisted={post.data.ai_assisted}
            />
          );
        })}
      </div>
    )}
  </section>
</BaseLayout>
