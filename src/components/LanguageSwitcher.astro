---
import { getCollection } from 'astro:content';
import {
  SECTION_FALLBACK_BY_LOCALE,
  localeFromPathname,
  normalizePathname,
  switchLocalePath,
} from '../lib/i18n';

const pathname = Astro.url.pathname;
const search = Astro.url.search;
const currentLocale = localeFromPathname(pathname);
const targetLocale = currentLocale === 'fr' ? 'en' : 'fr';
const normalizedPath = normalizePathname(pathname);

let targetPath = `${switchLocalePath(pathname, targetLocale)}${search}`;
const blogPostMatch = normalizedPath.match(/^\/(fr|en)\/blog\/([^/]+)$/);

if (blogPostMatch) {
  const slug = blogPostMatch[2];
  const includeDrafts = import.meta.env.DEV;
  const currentLangEntries = await getCollection(
    'blog',
    ({ data }) => data.lang === currentLocale && (includeDrafts || !data.draft),
  );
  const targetLangEntries = await getCollection(
    'blog',
    ({ data }) => data.lang === targetLocale && (includeDrafts || !data.draft),
  );

  const currentEntry = currentLangEntries.find((entry) => (entry.id.split('/').pop() ?? entry.id) === slug);
  const targetEntry = targetLangEntries.find((entry) => (entry.id.split('/').pop() ?? entry.id) === slug);

  if (targetEntry) {
    targetPath = `/${targetLocale}/blog/${slug}`;
  } else if (currentEntry?.data.kind === 'tip') {
    targetPath = SECTION_FALLBACK_BY_LOCALE[targetLocale].tips;
  } else {
    targetPath = SECTION_FALLBACK_BY_LOCALE[targetLocale].blog;
  }
}
---

<a class="language-switcher" href={targetPath} hreflang={targetLocale}>
  <span aria-current={currentLocale === 'fr' ? 'true' : undefined}>FR</span>
  <span aria-hidden="true">/</span>
  <span aria-current={currentLocale === 'en' ? 'true' : undefined}>EN</span>
</a>
