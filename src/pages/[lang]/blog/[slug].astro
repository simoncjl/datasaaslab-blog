---
import { getCollection, render, type CollectionEntry } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { LOCALES, type Locale } from '../../../lib/i18n';
import { buildAbsoluteUrl } from '../../../lib/seo';

interface Props {
  entry: CollectionEntry<'blog'> | null;
  otherLangEntry: CollectionEntry<'blog'> | null;
}

interface TocItem {
  depth: number;
  slug: string;
  text: string;
}

function slugifyHeading(text: string): string {
  return text
    .toLowerCase()
    .replace(/[^a-z0-9\s-]/g, '')
    .trim()
    .replace(/\s+/g, '-');
}

function extractHeadingsFromBody(body: string): TocItem[] {
  const seen = new Map<string, number>();
  const headings: TocItem[] = [];

  for (const line of body.split('\n')) {
    const match = line.match(/^(#{1,3})\s+(.+?)\s*$/);
    if (!match) continue;

    const depth = match[1].length;
    const rawText = match[2]
      .replace(/\[(.*?)\]\(.*?\)/g, '$1')
      .replace(/[`*_~]/g, '')
      .trim();
    if (!rawText) continue;

    const baseSlug = slugifyHeading(rawText);
    if (!baseSlug) continue;

    const count = seen.get(baseSlug) ?? 0;
    seen.set(baseSlug, count + 1);
    const slug = count === 0 ? baseSlug : `${baseSlug}-${count}`;

    headings.push({ depth, slug, text: rawText });
  }

  return headings;
}

export async function getStaticPaths() {
  const includeDrafts = import.meta.env.DEV;
  const entries = await getCollection('blog', ({ data }) => includeDrafts || !data.draft);

  const entryByKey = new Map<string, CollectionEntry<'blog'>>();
  const slugs = new Set<string>();

  for (const entry of entries) {
    const slug = entry.id.split('/').pop() ?? entry.id;
    slugs.add(slug);
    entryByKey.set(`${entry.data.lang}:${slug}`, entry);
  }

  const paths: Array<{
    params: { lang: Locale; slug: string };
    props: Props;
  }> = [];

  for (const slug of slugs) {
    for (const lang of LOCALES) {
      const otherLang = lang === 'fr' ? 'en' : 'fr';
      paths.push({
        params: { lang, slug },
        props: {
          entry: entryByKey.get(`${lang}:${slug}`) ?? null,
          otherLangEntry: entryByKey.get(`${otherLang}:${slug}`) ?? null,
        },
      });
    }
  }

  return paths;
}

const langParam = Astro.params.lang;
const slug = Astro.params.slug;

if (!langParam || !LOCALES.includes(langParam as Locale) || !slug) {
  return Astro.redirect('/fr/blog', 302);
}

const lang = langParam as Locale;
const { entry, otherLangEntry } = Astro.props as Props;

if (!entry && otherLangEntry) {
  return Astro.redirect(`/${otherLangEntry.data.lang}/blog/${slug}`, 302);
}

if (!entry) {
  Astro.response.status = 404;
}

const postTitle = entry ? `${entry.data.title} | DataSaaSLab` : '404 | DataSaaSLab';
const postDescription = entry?.data.description ?? 'Post not found.';
const canonicalPath = `/${lang}/blog/${slug}`;
const canonicalUrl = buildAbsoluteUrl(canonicalPath);

const frEquivalent =
  entry && entry.data.lang === 'fr' ? entry : otherLangEntry?.data.lang === 'fr' ? otherLangEntry : null;

const enEquivalent =
  entry && entry.data.lang === 'en' ? entry : otherLangEntry?.data.lang === 'en' ? otherLangEntry : null;

const frAltUrl = frEquivalent ? buildAbsoluteUrl(`/fr/blog/${slug}`) : null;
const enAltUrl = enEquivalent ? buildAbsoluteUrl(`/en/blog/${slug}`) : null;

const rendered = entry ? await render(entry) : null;
const Content = rendered?.Content;

const tocFromRender: TocItem[] = (rendered?.headings ?? [])
  .filter((heading) => heading.depth <= 3)
  .map((heading) => ({
    depth: heading.depth,
    slug: heading.slug,
    text: heading.text,
  }));

const tocItems = tocFromRender.length > 0 ? tocFromRender : entry ? extractHeadingsFromBody(entry.body) : [];
---

<BaseLayout title={postTitle} description={postDescription}>
  <Fragment slot="head">
    {canonicalUrl && <link rel="canonical" href={canonicalUrl} />}
    {frAltUrl && <link rel="alternate" hreflang="fr" href={frAltUrl} />}
    {enAltUrl && <link rel="alternate" hreflang="en" href={enAltUrl} />}
    <meta name="description" content={postDescription} />
    <meta property="og:type" content="article" />
    <meta property="og:title" content={postTitle} />
    <meta property="og:description" content={postDescription} />
    {canonicalUrl && <meta property="og:url" content={canonicalUrl} />}
  </Fragment>

  {entry && Content ? (
    <div class="article-layout">
      <article class="prose article-main">
        {entry.data.ai_assisted && (
          <p class="ai-assisted-note">
            {entry.data.lang === 'fr' ? 'AI-assisted · Revu par un humain' : 'AI-assisted · Human-reviewed'}
          </p>
        )}
        <h1>{entry.data.title}</h1>
        <p>{entry.data.description}</p>
        <Content />
      </article>

      {tocItems.length > 0 && (
        <aside class="toc-sidebar" aria-label={lang === 'fr' ? 'Table des matieres' : 'Table of contents'}>
          <nav class="toc-nav">
            <p class="toc-title">{lang === 'fr' ? 'Sur cette page' : 'On this page'}</p>
            <ul>
              {tocItems.map((item) => (
                <li class={`toc-item depth-${item.depth}`}>
                  <a href={`#${item.slug}`}>{item.text}</a>
                </li>
              ))}
            </ul>
          </nav>
        </aside>
      )}
    </div>
  ) : (
    <section>
      <h1>404</h1>
      <p>Post not found.</p>
    </section>
  )}
</BaseLayout>
